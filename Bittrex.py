import API_request
import re
import API_operations


class Bittrex:
    def __init__(self):
        self.__name = "BITTREX"
        self.__URL_BUILD = {
            "URL": "https://api.bittrex.com/v3/markets/",
            "market_info_URL": "https://api.bittrex.com/v3/markets",
            "withdrawal_fees_endpoint": "https://api.bittrex.com/v3/currencies",
            "orderbook_endp": "orderbook",
            "rates_endp": "ticker"
        }
        self.__fee_currency = "USD"
        self.__maker_taker_fees = [
            {"upper_bound": 5000, "takerFee": 0.0075, "makerFee": 0.0075},
            {"upper_bound": 10000, "takerFee": 0.0050, "makerFee": 0.0050},
            {"upper_bound": 25000, "takerFee": 0.0035, "makerFee": 0.0035},
            {"upper_bound": 50000, "takerFee": 0.0020, "makerFee": 0.0025},
            {"upper_bound": 1000000, "takerFee": 0.0012, "makerFee": 0.0018},
            {"upper_bound": 10000000, "takerFee": 0.0005, "makerFee": 0.0015},
            {"upper_bound": 60000000, "takerFee": 0, "makerFee": 0.0008},
            {"takerFee": 0, "makerFee": 0.0005}]
        self.__withdrawal_fees = {
            "1INCH": 3.50000000,
            "1ST": 4.50000000,
            "4ART": 120.00000000,
            "AAPL": 0.00000000,
            "AAVE": 0.10000000,
            "ABBC": 0.10000000,
            "ABNB": 0.00000000,
            "ABT": 72.00000000,
            "ABYSS": 316.00000000,
            "ACB": 0.00000000,
            "ACXT": 1.00000000,
            "ADA": 1.00000000,
            "ADABEAR": 12.64000000,
            "ADABULL": 0.00400000,
            "ADK": 0.00000000,
            "ADT": 14250.00000000,
            "ADX": 12.00000000,
            "AEON": 0.10000000,
            "AERGO": 119.00000000,
            "AGRS": 14.00000000,
            "AID": 152.00000000,
            "AKN": 0.10000000,
            "AKRO": 643.00000000,
            "AKT": 0.01000000,
            "ALGO": 0.10000000,
            "AMC": 0.00000000,
            "AMD": 0.00000000,
            "AMP": 814.00000000,
            "AMZN": 0.00000000,
            "ANKR": 98.00000000,
            "ANT": 2.00000000,
            "APHA": 0.00000000,
            "APIX": 40.00000000,
            "APM": 460.00000000,
            "AR": 1.00000000,
            "ARDR": 2.00000000,
            "ARDX": 127.00000000,
            "ARK": 0.10000000,
            "ARKK": 0.00000000,
            "ART": 1427.00000000,
            "ATOM": 0.00400000,
            "AVAX": 0.00100000,
            "BABA": 0.00000000,
            "BAL": 0.35000000,
            "BAND": 3.00000000,
            "BAT": 14.00000000,
            "BAX": 19273.00000000,
            "BB": 0.00000000,
            "BBC": 0.01000000,
            "BCH": 0.00100000,
            "BCPT": 276.00000000,
            "BEAR": 9.00000000,
            "BEST": 20.00000000,
            "BFT": 195.00000000,
            "BILI": 0.00000000,
            "BITW": 0.00000000,
            "BLK": 0.02000000,
            "BLOC": 21409.00000000,
            "BLOCK": 0.02000000,
            "BLT": 125.00000000,
            "BLTV": 5352.00000000,
            "BNT": 2.50000000,
            "BNTX": 0.00000000,
            "BOA": 44.00000000,
            "BONDLY": 45.00000000,
            "BORA": 63.00000000,
            "BOXX": 275.00000000,
            "BRZ": 54.00000000,
            "BST": 21.00000000,
            "BSV": 0.00100000,
            "BTC": 0.00030000,
            "BTCV": 0.01000000,
            "BTE": 7.00000000,
            "BTM": 0.10000000,
            "BTS": 5.00000000,
            "BTT": 1.00000000,
            "BTU": 19.00000000,
            "BTXCRD": 0.01000000,
            "BULL": 0.00170000,
            "BURST": 2.00000000,
            "BWF": 891.00000000,
            "BWX": 282.00000000,
            "BYND": 0.00000000,
            "CADX": 1.00000000,
            "CAMP": 14250.00000000,
            "CBC": 148.00000000,
            "CEL": 1.45000000,
            "CELO": 0.01000000,
            "CGC": 0.00000000,
            "CGT": 0.45000000,
            "CHR": 188.00000000,
            "CKB": 0.01000000,
            "CLT": 1.10000000,
            "CMCT": 10704.00000000,
            "CND": 1539.00000000,
            "CNS": 0.05000000,
            "CNTM": 56.00000000,
            "COIN": 0.00000000,
            "COMP": 0.02460000,
            "COSM": 1.00000000,
            "CPC": 1096.00000000,
            "CPT": 1.00000000,
            "CRO": 0.01000000,
            "CRON": 0.00000000,
            "CRV": 5.00000000,
            "CRW": 0.02000000,
            "CTC": 3.50000000,
            "CTXC": 0.01000000,
            "CURE": 0.00020000,
            "CUSD": 0.01000000,
            "CUT": 64.00000000,
            "CVC": 32.00000000,
            "CVT": 310.00000000,
            "DACXI": 100.00000000,
            "DAF": 174.00000000,
            "DAI": 10.00000000,
            "DASH": 0.05000000,
            "DAWN": 4.00000000,
            "DCR": 0.01000000,
            "DENT": 1881.00000000,
            "DEP": 1583.00000000,
            "DFI": 0.10000000,
            "DGB": 0.20000000,
            "DMT": 15.00000000,
            "DNA": 0.01000000,
            "DNT": 145.00000000,
            "DOGE": 5.00000000,
            "DOGEBULL": 0.00010000,
            "DOT": 0.50000000,
            "DRGN": 73.00000000,
            "DTA": 30.00000000,
            "DUCATO": 0.60000000,
            "DUSK": 81.00000000,
            "ECELL": 248.00000000,
            "ECOC": 0.01000000,
            "EDG": 0.10000000,
            "EDGELESS": 765.00000000,
            "EDR": 238.00000000,
            "ELA": 0.01000000,
            "ELAMA": 679.00000000,
            "ELF": 38.00000000,
            "EMC2": 0.20000000,
            "ENG": 128.00000000,
            "ENJ": 7.00000000,
            "EOS": 0.10000000,
            "ETC": 0.01000000,
            "ETH": 0.00190000,
            "ETHBEAR": 100.00000000,
            "ETHBULL": 0.01300000,
            "EUR": 0.00000000,
            "EXCL": 0.20000000,
            "EXE": 3563.00000000,
            "EXP": 0.01000000,
            "FB": 0.00000000,
            "FCT": 0.01000000,
            "FCT2": 96.00000000,
            "FET": 88.00000000,
            "FIL": 0.04000000,
            "FIRO": 0.10000000,
            "FIT": 5700.00000000,
            "FLETA": 838.00000000,
            "FLO": 0.20000000,
            "FME": 7125.00000000,
            "FNB": 3563.00000000,
            "FOL": 6.00000000,
            "FOR": 259.00000000,
            "FRSP": 28500.00000000,
            "FSN": 0.00600000,
            "FTC": 0.20000000,
            "FTM": 432.00000000,
            "FUN": 1600.00000000,
            "FX": 26.00000000,
            "GAME": 56.00000000,
            "GBYTE": 0.00200000,
            "GDXJ": 0.00000000,
            "GEO": 0.10000000,
            "GET": 2.50000000,
            "GLD": 0.00000000,
            "GLEEC": 0.10000000,
            "GLM": 35.00000000,
            "GLXY": 0.00000000,
            "GME": 0.00000000,
            "GNC": 0.01000000,
            "GNO": 0.05000000,
            "GNY": 16.00000000,
            "GO": 1.00000000,
            "GOLD": 46.16000000,
            "GOOGL": 0.00000000,
            "GRIN": 0.10000000,
            "GRS": 0.20000000,
            "GRT": 14.00000000,
            "GST": 0.10000000,
            "GTO": 291.00000000,
            "GUP": 2487.00000000,
            "GXC": 0.30000000,
            "HBAR": 0.10000000,
            "HBD": 0.01000000,
            "HDAC": 1.00000000,
            "HDAO": 792.00000000,
            "HEDG": 10.00000000,
            "HINT": 2666.00000000,
            "HIVE": 0.01000000,
            "HMQ": 1676.00000000,
            "HNS": 0.10000000,
            "HXRO": 14.00000000,
            "HYC": 2288.00000000,
            "HYDRO": 25591.00000000,
            "ICX": 0.02000000,
            "IGNIS": 2.00000000,
            "IHT": 3568.00000000,
            "INCNT": 0.10000000,
            "INSTAR": 0.10000000,
            "INX": 9500.00000000,
            "INXT": 2.50000000,
            "IOC": 0.20000000,
            "ION": 0.20000000,
            "IOST": 1.00000000,
            "IOTA": 0.50000000,
            "IOTX": 401.00000000,
            "IQQ": 152.00000000,
            "IRIS": 0.04000000,
            "ITM": 1.00000000,
            "JASMY": 20.00000000,
            "JOB": 7125.00000000,
            "KAI": 128.00000000,
            "KDA": 0.10000000,
            "KDAG": 24.00000000,
            "KLAY": 0.00600000,
            "KLV": 5.50000000,
            "KMD": 0.00200000,
            "KNC": 6.00000000,
            "KOK": 10.00000000,
            "KRT": 3625.00000000,
            "KSM": 0.10000000,
            "LAMB": 232.00000000,
            "LBC": 0.02000000,
            "LCS": 1.00000000,
            "LINK": 0.35000000,
            "LMCH": 14250.00000000,
            "LOOM": 136.00000000,
            "LOON": 582.00000000,
            "LRC": 26.00000000,
            "LSK": 0.10000000,
            "LTC": 0.01000000,
            "LUCY": 0.20000000,
            "LUNA": 2.20000000,
            "MAID": 10.00000000,
            "MANA": 13.00000000,
            "MARO": 0.00600000,
            "MATIC": 6.00000000,
            "MCH": 94.71000000,
            "MDT": 313.00000000,
            "ME": 1357.00000000,
            "MED": 10.00000000,
            "MEME": 0.02000000,
            "MER": 0.10000000,
            "MET": 3.00000000,
            "META": 0.00600000,
            "MFA": 1018.00000000,
            "MFT": 1188.00000000,
            "MKR": 0.00290000,
            "MLN": 0.32000000,
            "MMAON": 533.00000000,
            "MOBI": 1.00000000,
            "MOC": 100.00000000,
            "MOF": 20.00000000,
            "MOGX": 1.00000000,
            "MONA": 0.20000000,
            "MORE": 380.00000000,
            "MRNA": 0.00000000,
            "MRPH": 12.00000000,
            "MSTR": 0.00000000,
            "MTC": 0.00000000,
            "MTL": 5.00000000,
            "MUE": 0.02000000,
            "MYID": 2065.00000000,
            "MYST": 26.00000000,
            "NAV": 0.20000000,
            "NCASH": 6705.00000000,
            "NDAU": 0.10000000,
            "NEO": 0.02500000,
            "NFLX": 0.00000000,
            "NFTX": 1.00000000,
            "NGC": 303.00000000,
            "NIO": 0.00000000,
            "NKN": 28.00000000,
            "NLC2": 0.10000000,
            "NLG": 0.20000000,
            "NMR": 0.20000000,
            "NOK": 0.00000000,
            "NPXS": 46649.00000000,
            "NVDA": 0.00000000,
            "NVT": 0.04000000,
            "NXS": 0.20000000,
            "NXT": 2.00000000,
            "OCEAN": 35.00000000,
            "OCN": 16293.00000000,
            "OGN": 9.00000000,
            "OGO": 571.00000000,
            "OGT": 21.00000000,
            "OK": 0.20000000,
            "OMG": 1.60000000,
            "OMNI": 0.10000000,
            "ONG": 0.10000000,
            "ONT": 1.00000000,
            "ORBS": 131.00000000,
            "OST": 389.00000000,
            "OXEN": 0.20000000,
            "OXT": 26.00000000,
            "PAL": 1.00000000,
            "PANDO": 26.93000000,
            "PART": 0.10000000,
            "PAX": 10.00000000,
            "PAY": 145.00000000,
            "PENN": 0.00000000,
            "PFE": 0.00000000,
            "PHNX": 111.00000000,
            "PI": 1.00000000,
            "PINK": 0.20000000,
            "PIST": 8.00000000,
            "PIVX": 0.02000000,
            "PLA": 9500.00000000,
            "PLG": 21409.00000000,
            "PMA": 28500.00000000,
            "POLC": 1.00000000,
            "POLY": 170.00000000,
            "POT": 0.00200000,
            "POWR": 41.00000000,
            "PPAY": 47.00000000,
            "PPC": 0.02000000,
            "PRO": 49.00000000,
            "PROM": 0.70000000,
            "PROS": 1.55000000,
            "PRT": 178.00000000,
            "PTON": 28500.00000000,
            "PTOY": 538.00000000,
            "PUNDIX": 7.00000000,
            "PXL": 1.00000000,
            "PYPL": 0.00000000,
            "QLC": 0.00000000,
            "QNT": 0.25000000,
            "QRL": 0.10000000,
            "QTUM": 0.01000000,
            "RAMP": 42.00000000,
            "RCN": 156.00000000,
            "RDD": 2.00000000,
            "REN": 17.00000000,
            "RENBTC": 0.00030000,
            "REPV2": 0.60000000,
            "REV": 1215.00000000,
            "REVV": 81.00000000,
            "RFOX": 91.00000000,
            "RFR": 5352.00000000,
            "RGT": 1.00000000,
            "RLC": 1.85000000,
            "ROC": 62.00000000,
            "ROOM": 20.00000000,
            "RSR": 277.00000000,
            "RSV": 1.00000000,
            "RVC": 1.00000000,
            "RVN": 1.00000000,
            "SAND": 166.00000000,
            "SBD": 0.01000000,
            "SBT": 7520.00000000,
            "SC": 0.10000000,
            "SDT": 4.40000000,
            "SENSO": 12.00000000,
            "SG": 0.76140000,
            "SHR": 1111.00000000,
            "SIB": 0.20000000,
            "SIG": 14.00000000,
            "SIX": 0.10000000,
            "SKM": 3167.00000000,
            "SLICE": 15.00000000,
            "SLS": 0.00200000,
            "SLV": 0.00000000,
            "SMARTCREDIT": 2.80000000,
            "SMBSWAP": 22.00000000,
            "SNT": 262.00000000,
            "SNX": 1.60000000,
            "SOLVE": 187.00000000,
            "SPC": 197.00000000,
            "SPHR": 0.10000000,
            "SPI": 0.20000000,
            "SPIN": 10.00000000,
            "SPY": 0.00000000,
            "SQ": 0.00000000,
            "SRN": 864.00000000,
            "STC": 432.00000000,
            "STEEM": 0.01000000,
            "STMX": 419.00000000,
            "STORJ": 10.00000000,
            "STPT": 208.00000000,
            "STRAX": 0.01000000,
            "STRK": 0.25000000,
            "SUKU": 28.00000000,
            "SUSD": 8.00000000,
            "SUTER": 969.00000000,
            "SWT": 160.00000000,
            "SXP": 5.00000000,
            "SYLO": 2152.00000000,
            "SYS": 0.00020000,
            "TEA": 41.00000000,
            "TEMCO": 10.00000000,
            "TFC": 0.10000000,
            "THC": 1.00000000,
            "TNC": 0.00000000,
            "TRAC": 33.00000000,
            "TRIO": 8888.00000000,
            "TRX": 0.00300000,
            "TRYB": 85.00000000,
            "TSHP": 983.00000000,
            "TSLA": 0.00000000,
            "TSM": 0.00000000,
            "TUBE": 0.01000000,
            "TUDA": 1781.00000000,
            "TUSD": 10.00000000,
            "TWTR": 0.00000000,
            "UBER": 0.00000000,
            "UBQ": 0.01000000,
            "UBT": 27.00000000,
            "UCT": 2375.00000000,
            "UMA": 1.90000000,
            "UNI": 0.40000000,
            "UPCO2": 1.45000000,
            "UPEUR": 9.00000000,
            "UPP": 113.00000000,
            "UPT": 950.00000000,
            "UPUSD": 12.00000000,
            "UPXAU": 0.00550000,
            "UQC": 0.55000000,
            "URAC": 14250.00000000,
            "URQA": 39.00000000,
            "USD": 0.00000000,
            "USDC": 10.00000000,
            "USDN": 0.10000000,
            "USDS": 10.00000000,
            "USDT": 10.00000000,
            "USO": 0.00000000,
            "UST": 3.08000000,
            "UTI": 9500.00000000,
            "UTK": 32.00000000,
            "VAL": 0.20000000,
            "VANY": 9500.00000000,
            "VBK": 0.05000000,
            "VDX": 14316.00000000,
            "VEE": 1188.00000000,
            "VET": 100.00000000,
            "VIA": 0.20000000,
            "VIB": 205.00000000,
            "VID": 46.00000000,
            "VIL": 0.60000000,
            "VITE": 110.00000000,
            "VLX": 0.01000000,
            "VRA": 467.00000000,
            "VRC": 0.00020000,
            "VTC": 0.02000000,
            "VVT": 178.00000000,
            "WAVES": 0.00100000,
            "WAXP": 0.10000000,
            "WBTC": 0.00030000,
            "WGP": 1900.00000000,
            "WIB": 1.00000000,
            "WICC": 0.01000000,
            "WINGS": 211.00000000,
            "WXBTC": 3.50000000,
            "XDB": 242.00000000,
            "XDN": 0.02000000,
            "XEL": 0.20000000,
            "XELS": 1.75000000,
            "XEM": 4.00000000,
            "XEP": 0.00100000,
            "XHV": 0.01000000,
            "XLM": 0.05000000,
            "XMR": 0.00010000,
            "XMY": 0.20000000,
            "XNK": 2666.00000000,
            "XRP": 1.00000000,
            "XSR": 823.00000000,
            "XST": 0.02000000,
            "XTP": 7125.00000000,
            "XTZ": 0.25000000,
            "XUC": 46.00000000,
            "XVG": 5.00000000,
            "XWC": 0.01000000,
            "XYM": 1.00000000,
            "XYO": 12480.00000000,
            "YFL": 0.10000000,
            "YOU": 160.00000000,
            "ZEC": 0.01000000,
            "ZEN": 0.00200000,
            "ZIL": 0.00200000,
            "ZILD": 0.05000000,
            "ZM": 0.00000000,
            "ZRX": 10.00000000,
            "ZUSD": 12.00000000
        }

    def get_name(self):
        return self.__name

    def get_fee_currency(self):
        return self.__fee_currency

    def get_maker_taker_list(self):
        return self.__maker_taker_fees

    def get_withdrawal_list(self):
        return self.__withdrawal_fees

    def value_of_curr_in_api_curr(self, currency):
        possible_currencies = [self.__fee_currency, "EUR", "PLN"]
        for curr in possible_currencies:
            trading_pair = f'{currency}-{curr}'
            market = API_request.make_request(
                f'{self.__URL_BUILD["market_info_URL"]}/{trading_pair}/{self.__URL_BUILD["rates_endp"]}')
            if market is not None:
                return API_operations.get_value_user_curr(curr, self.__fee_currency, float(market["bidRate"]))
        raise Exception(f"There is no highest bid in BITTREX API for {currency} to calculate fee")

    def get_maker_taker_fee(self, user_money_spent_on_api: float):
        i = 0
        length = len(self.get_maker_taker_list())
        fees = self.get_maker_taker_list()
        while i < length - 2:
            if user_money_spent_on_api > fees[i]["upper_bound"]:
                i += 1
            else:
                return {"taker_fee": fees[i]["takerFee"], "maker_fee": fees[i]["makerFee"]}
        if i == length - 2:
            return {"taker_fee": fees[length - 1]["takerFee"], "maker_fee": fees[length - 1]["makerFee"]}

    def get_withdrawal_fee(self, currency: str):
        return self.__withdrawal_fees[currency]

    def request_bids_and_asks(self, currencies: tuple[str, str]):
        trading_pair = f'{currencies[0]}-{currencies[1]}'
        offers = API_request.make_request(
            f'{self.__URL_BUILD["URL"]}{trading_pair}/{self.__URL_BUILD["orderbook_endp"]}')
        if offers is not None:
            return offers
        else:
            raise Exception(f"Empty bids and asks list in BITTREX for ({currencies[0]},{currencies[1]})")

    def request_market_data(self):
        markets = API_request.make_request(f'{self.__URL_BUILD["market_info_URL"]}')
        markets_list = []
        if markets is not None:
            for market in markets:
                symbols = re.split("-", market["symbol"])
                markets_list.append((symbols[0], symbols[1]))
        return markets_list

    def get_ticker_rate(self, currencies: tuple[str, str]):
        trading_pair = f'{currencies[0]}-{currencies[1]}'
        data = API_request.make_request(
            f'{self.__URL_BUILD["URL"]}{trading_pair}/{self.__URL_BUILD["rates_endp"]}')
        return data["bidRate"]
